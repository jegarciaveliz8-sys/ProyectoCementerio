<!DOCTYPE html>
<html>
<head>
    <title>SISTEMA CEMENTERIO SANARATE</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html { height: 100%; margin: 0; font-family: Arial, sans-serif; }
        #map { height: 100vh; width: 100%; }
        .panel { 
            position: absolute; top: 10px; left: 10px; z-index: 1000; 
            background: white; padding: 15px; border-radius: 8px; width: 280px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4); border-top: 5px solid #007bff;
        }
        .btn-admin {
            position: fixed; top: 15px; right: 15px; z-index: 2000;
            background: #28a745; color: white; padding: 12px;
            text-decoration: none; border-radius: 8px; font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4); border: 2px solid white;
        }
    </style>
</head>
<body>
    <a href="/admin/registros/nicho/" class="btn-admin">游늭 IR A ADMINISTRACI칍N</a>
    
    <div class="panel">
        <h3 style="margin-top:0">游댌 BUSCADOR</h3>
        <input type="text" id="bus" style="width:100%;padding:10px;box-sizing:border-box;margin-bottom:10px;" placeholder="Ej: A1-1-025">
        <button onclick="buscar()" style="width:100%;padding:10px;background:#007bff;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:bold">BUSCAR Y ENFOCAR</button>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // 1. Inicializar mapa
        var map = L.map('map').setView([14.78220, -90.20450], 19);
        L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', { maxZoom: 22 }).addTo(map);

        // 2. Cargar datos
        var listos = {{ listos_json|safe }};
        var marcadores = {}; 

        // 3. Crear puntos en el mapa
        listos.forEach(function(n) {
            var esOcupado = (n.difunto && n.difunto.trim() !== "" && n.difunto.toUpperCase() !== "DISPONIBLE");
            
            var m = L.circleMarker([n.lat, n.lng], {
                radius: 6, 
                color: esOcupado ? 'red' : 'green', 
                fillColor: esOcupado ? 'red' : 'green', 
                fillOpacity: 0.8
            }).addTo(map);
            
            // Agregar el globo de informaci칩n
            m.bindTooltip("<b>Nicho: " + n.codigo + "</b><br>" + (n.difunto || "Disponible"));
            
            // Guardar en el diccionario para el buscador (en may칰sculas)
            marcadores[n.codigo.toUpperCase().trim()] = m;
        });

        // 4. Funci칩n de b칰squeda
        function buscar() {
            var input = document.getElementById("bus");
            var codigoBusqueda = input.value.toUpperCase().trim();
            
            if (marcadores[codigoBusqueda]) {
                var marcador = marcadores[codigoBusqueda];
                // Mover mapa al punto y hacer zoom
                map.setView(marcador.getLatLng(), 21);
                // Abrir el globo autom치ticamente
                marcador.openTooltip();
            } else {
                alert("El c칩digo '" + codigoBusqueda + "' no existe en el sistema.");
            }
        }

        // Permitir buscar al presionar "Enter"
        document.getElementById("bus").addEventListener("keyup", function(event) {
            if (event.key === "Enter") {
                buscar();
            }
        });
    </script>
</body>
</html>
