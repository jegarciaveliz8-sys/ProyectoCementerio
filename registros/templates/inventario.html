{% extends 'base.html' %}
{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-9">
            <div id="map" style="height: 85vh; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);"></div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 shadow-sm">
                <h5>游늸 Reubicaci칩n</h5>
                <p class="small text-muted">Arrastre el marcador azul para mover el nicho y dele a "Guardar".</p>
                <hr>
                <div id="info-nicho">
                    <p>Seleccione un nicho del listado o del mapa.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<script>
    // Configuraci칩n inicial del cementerio
    var map = L.map('map').setView([14.7814, -90.2024], 18);
    L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
        attribution: 'Google Satellite'
    }).addTo(map);

    // Iconos para diferenciar estados
    var iconVerde = new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png', shadowSize: [41, 41], iconSize: [25, 41], iconAnchor: [12, 41] });
    var iconRojo = new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', shadowSize: [41, 41], iconSize: [25, 41], iconAnchor: [12, 41] });

    // Aqu칤 est치 el truco: Cargamos los nichos limpiando las comas
    {% for n in nichos %}
        (function() {
            // Convertimos comas a puntos para que JS no se trabe
            var lat = parseFloat("{{ n.lat }}".replace(',', '.'));
            var lng = parseFloat("{{ n.lng }}".replace(',', '.'));
            
            // FILTRO: Si es la coordenada de reserva (la torre), NO lo dibujamos para no saturar
            // Solo dibujamos los que ya tienen coordenadas distintas a la base 14.781402
            if (lat !== 14.781402) {
                var m = L.marker([lat, lng], {
                    icon: "{{ n.estado_id }}" == "1" ? iconVerde : iconRojo
                }).addTo(map);
                
                m.bindPopup("<b>C칩digo: {{ n.codigo }}</b><br>Estado: {{ n.get_estado_id_display }}");
            }
        })();
    {% endfor %}
</script>
{% endblock %}
