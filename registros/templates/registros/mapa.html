<!DOCTYPE html>
<html>
<head>
    <title>Mapa Cementerio - Blindado</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        body { margin: 0; display: flex; height: 100vh; font-family: sans-serif; }
        #sidebar { width: 300px; background: #2c3e50; color: white; overflow-y: auto; padding: 15px; border-right: 2px solid #1a252f; }
        #map { flex-grow: 1; cursor: crosshair !important; }
        .nicho-item { padding: 10px; border-bottom: 1px solid #34495e; cursor: pointer; transition: 0.2s; }
        .nicho-item:hover { background: #1abc9c; }
        .seleccionado { background: #27ae60 !important; font-weight: bold; border-left: 5px solid white; }
        /* Color especial para los que ya est谩n listos */
        .ya-ubicado { border-right: 8px solid #3498db; background: #243342; }
        input { width: 100%; padding: 10px; margin-bottom: 15px; border-radius: 4px; border: none; }
        .instrucciones { font-size: 0.8em; color: #bdc3c7; margin-bottom: 10px; }
        .badge { font-size: 0.7em; background: #3498db; padding: 2px 5px; border-radius: 3px; float: right; }
    </style>
</head>
<body>
    <div id="sidebar">
        <h4>NICHOS SANARATE</h4>
        <div class="instrucciones"> Azul = Ya ubicado<br> Verde = Seleccionado</div>
        <input type="text" id="bus" placeholder=" Buscar c贸digo..." onkeyup="filtrar()">
        <div id="lista"></div>
    </div>
    <div id="map"></div>

    <script>
        var map = L.map('map').setView([14.78225, -90.20425], 19);
function buscarNicho(codigo) { var n = nichos.find(x => x.codigo === codigo); if(n && n.lat != 0) { map.flyTo([n.lat, n.lng], 20); } else { alert("Nicho no encontrado o sin coordenadas"); } }
        L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', { 
            maxZoom: 22, 
            subdomains:['mt0','mt1','mt2','mt3'] 
        }).addTo(map);

        var nichos = {{ todos_json|safe }};
        var idActivo = null;

        function dibujar() {
            const lista = document.getElementById('lista');
            lista.innerHTML = '';
            let filtro = document.getElementById('bus').value.toUpperCase();
            
            nichos.filter(n => n.codigo.includes(filtro)).forEach(n => {
                let div = document.createElement('div');
                let estaUbicado = n.lat != 0 && n.lat != null;
                
                div.className = 'nicho-item' + 
                                (idActivo == n.id ? ' seleccionado' : '') + 
                                (estaUbicado ? ' ya-ubicado' : '');
                
                div.innerHTML = "<b>" + n.codigo + "</b>" + 
                                (estaUbicado ? '<span class="badge">LISTO</span>' : '') +
                                "<br><small>" + n.nombre_difunto + "</small>";
                
                div.onclick = function() { idActivo = n.id; dibujar(); };
                lista.appendChild(div);
                
                if(estaUbicado) {
                    L.circleMarker([n.lat, n.lng], {
                        radius: 6, 
                        color: '#3498db', 
                        fillColor: '#3498db', 
                        fillOpacity: 0.8
                    }).addTo(map).bindPopup("C贸digo: " + n.codigo);
                }
            });
        }

        map.on('click', function(e) {
            if(!idActivo) return alert("锔 Selecciona un c贸digo primero.");

            // BLINDAJE: Verificar si ya tiene coordenadas
            let nichoActual = nichos.find(x => x.id == idActivo);
            if(nichoActual.lat != 0 && nichoActual.lat != null) {
                if(!confirm("锔 Este nicho YA EST UBICADO. 驴Est谩s seguro que quieres cambiarlo de lugar?")) {
                    return; // Cancela la operaci贸n
                }
            }

            fetch('/actualizar-posicion/', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}' 
                },
                body: JSON.stringify({ id: idActivo, lat: e.latlng.lat, lng: e.latlng.lng })
            })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'ok') {
                    location.reload();
                }
            });
        });

        function filtrar() { 
    dibujar(); 
    let filtro = document.getElementById("bus").value.toUpperCase(); 
    let n = nichos.find(x => x.codigo === filtro); 
    if(n && n.lat != 0) { map.flyTo([n.lat, n.lng], 21); } 
}
        dibujar();
    </script>
</body>
</html>
