<!DOCTYPE html>
<html>
<head>
    <title>Sistema Municipal - Sanarate Pro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, sans-serif; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* Panel Lateral */
        .panel-busqueda {
            position: absolute; top: 10px; left: 10px; z-index: 1000;
            background: white; padding: 15px; border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4); width: 280px;
        }

        /* Bot√≥n Administrador */
        .btn-admin {
            display: block; text-align: center; background: #343a40; color: white !important;
            text-decoration: none; padding: 10px; border-radius: 6px; font-weight: bold;
            margin-bottom: 12px; font-size: 14px; transition: 0.3s;
        }
        .btn-admin:hover { background: #000; }

        .stats-box {
            margin: 10px 0; padding: 10px; background: #f0f4f7;
            border-radius: 6px; border-left: 5px solid #1b5e20;
            font-size: 12px; line-height: 1.6; color: #333;
        }
        .filtros { display: flex; gap: 4px; margin-bottom: 10px; flex-wrap: wrap; }
        .btn-filtro { font-size: 10px; padding: 6px 8px; border-radius: 4px; border: 1px solid #ccc; cursor: pointer; background: #fff; font-weight: bold; }
        
        input { width: 100%; padding: 12px; border: 2px solid #28a745; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
        .resultados-container { max-height: 200px; overflow-y: auto; margin-top: 10px; border-top: 1px solid #eee; }
        .item-nicho { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 13px; }

        /* Bot√≥n GPS */
        .btn-gps {
            position: absolute; bottom: 30px; right: 20px; z-index: 1000;
            background: white; border: 2px solid #28a745; border-radius: 50%;
            box-shadow: 0 2px 15px rgba(0,0,0,0.3); cursor: pointer;
            width: 55px; height: 55px; font-size: 25px; display: flex; align-items: center; justify-content: center;
        }

        /* Estilos del Popup */
        .popup-nicho { min-width: 200px; padding: 5px; }
        .popup-title { font-size: 17px; color: #1b5e20; font-weight: bold; display: block; margin-bottom: 5px; }
        .popup-label { font-weight: bold; color: #555; }
        .coord-info { font-family: monospace; font-size: 11px; color: #444; background: #f4f4f4; padding: 6px; border-radius: 4px; display: block; margin: 10px 0; border: 1px solid #ddd; }
        .btn-pdf { display: block; text-align: center; padding: 10px; background: #007bff; color: white !important; text-decoration: none; border-radius: 5px; font-weight: bold; font-size: 14px; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="panel-busqueda">
        <a href="/admin/" class="btn-admin">‚öôÔ∏è IR A ADMINISTRACI√ìN</a>

        <div style="font-weight: bold; color: #1b5e20; margin-bottom: 10px; font-size: 16px;">üèõÔ∏è GESTI√ìN SANARATE</div>
        
        <input type="text" id="txtBusqueda" placeholder="Buscar Nombre o C√≥digo..." onkeyup="buscarEnTiempoReal()">
        
        <div class="filtros" style="margin-top:10px;">
            <button class="btn-filtro" onclick="filtrarMapa('TODOS')">TODOS</button>
            <button class="btn-filtro" style="color:#15803d" onclick="filtrarMapa('LIBRE')">LIBRES</button>
            <button class="btn-filtro" style="color:#b91c1c" onclick="filtrarMapa('DEUDA')">MORA</button>
        </div>
        <div id="stats" class="stats-box">Calculando...</div>
        <div id="resultados" class="resultados-container"></div>
    </div>

    <button class="btn-gps" onclick="verMiUbicacion()">üìç</button>

    <div id="map"></div>

    <script>
        var map = L.map('map', { maxZoom: 22 }).setView([14.78220, -90.19150], 18);
        L.tileLayer('http://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
            maxZoom: 22, subdomains:['mt0','mt1','mt2','mt3']
        }).addTo(map);

        var nichosData = {{ listos_json|safe }};
        var layers = [];
        var marcadorUsuario = null;
        var markersDict = {}; // Para b√∫squeda r√°pida por ID

        function cargarMapa(filtro = 'TODOS') {
            layers.forEach(l => map.removeLayer(l));
            layers = [];
            let c = { total: 0, libres: 0, deuda: 0, ok: 0 };

            nichosData.forEach(function(n) {
                let esDeuda = (n.color === 'red');
                let esLibre = (n.difunto === "DISPONIBLE");
                c.total++;
                if (esLibre) c.libres++; else if (esDeuda) c.deuda++; else c.ok++;

                if (n.lat == 0 || n.lng == 0) return;
                if (filtro === 'DEUDA' && !esDeuda) return;
                if (filtro === 'LIBRE' && !esLibre) return;

                let marker = L.circleMarker([n.lat, n.lng], {
                    radius: 7, fillColor: n.color, color: "#fff", weight: 2, fillOpacity: 0.9
                }).addTo(map);

                let popupContent = `
                    <div class="popup-nicho">
                        <span class="popup-title">Nicho: ${n.codigo}</span><hr>
                        <span class="popup-label">üë§ Due√±o:</span> ${n.propietario}<br>
                        <span class="popup-label">‚ö∞Ô∏è Difunto:</span> ${n.difunto}<br>
                        <span class="popup-label">üìÖ Vencimiento:</span> ${n.vencimiento || 'N/A'}<br>
                        <span class="coord-info">üìç GPS: ${n.lat}, ${n.lng}</span>
                        <a href='/generar-titulo/${n.id}/' class='btn-pdf' target='_blank'>üñ®Ô∏è IMPRIMIR T√çTULO</a>
                    </div>
                `;
                marker.bindPopup(popupContent);
                marker.nichoData = n;
                layers.push(marker);
                markersDict[n.id] = marker; // Guardamos referencia
            });

            document.getElementById('stats').innerHTML = `
                <b>RESUMEN:</b><br>
                üìä Total: ${c.total} | üî¥ Mora: ${c.deuda}<br>
                üü¢ Libres: ${c.libres} | üîµ Al d√≠a: ${c.ok}
            `;

            // --- L√ìGICA DE SALTO AUTOM√ÅTICO ---
            console.log("ID RECIBIDO:", "{{ nicho_seleccionado }}"); var seleccionadoId = "{{ nicho_seleccionado }}";
            if (seleccionadoId && markersDict[seleccionadoId]) {
                var m = markersDict[seleccionadoId];
                map.setView(m.getLatLng(), 21);
                m.openPopup();
            }
        }

        function verMiUbicacion() { map.locate({setView: true, maxZoom: 19}); }
        map.on('locationfound', function(e) {
            if (marcadorUsuario) map.removeLayer(marcadorUsuario);
            marcadorUsuario = L.circleMarker(e.latlng, {
                radius: 10, fillColor: "#007bff", color: "white", weight: 3, fillOpacity: 1
            }).addTo(map).bindPopup("<b>Usted est√° aqu√≠</b>").openPopup();
        });

        function buscarEnTiempoReal() {
            var s = document.getElementById('txtBusqueda').value.toUpperCase();
            var res = document.getElementById('resultados');
            res.innerHTML = "";
            if (s.length < 2) return;
            layers.forEach(function(m) {
                var n = m.nichoData;
                if (n.codigo.includes(s) || n.difunto.includes(s) || n.propietario.includes(s)) {
                    var div = document.createElement('div');
                    div.className = 'item-nicho';
                    div.innerHTML = `<b>${n.codigo}</b><br><small>${n.difunto}</small>`;
                    div.onclick = function() { map.setView(m.getLatLng(), 21); m.openPopup(); };
                    res.appendChild(div);
                }
            });
        }

        function filtrarMapa(t) { cargarMapa(t); }
        cargarMapa();
    </script>
</body>
</html>
