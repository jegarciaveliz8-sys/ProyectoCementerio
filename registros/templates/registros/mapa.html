<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Mapa Cementerio - Blindado</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        body { margin: 0; display: flex; height: 100vh; font-family: sans-serif; overflow: hidden; }
        #map { flex-grow: 1; height: 100vh; cursor: crosshair !important; z-index: 1; }
        #sidebar { width: 300px; background: #2c3e50; color: white; overflow-y: auto; padding: 15px; border-right: 2px solid #1a252f; z-index: 2000; transition: 0.3s; }
        
        /* Ajustes para Celular */
        #btn-menu { display: none; } 
        #btn-admin { position: fixed; top: 10px; right: 10px; z-index: 3000; background: #34495e; color: white; padding: 12px; border-radius: 5px; text-decoration: none; font-weight: bold; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        
        @media (max-width: 768px) {
            #btn-menu { display: block; position: fixed; top: 10px; left: 10px; z-index: 3000; background: #1abc9c; color: white; padding: 12px; border-radius: 5px; border: none; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        #btn-admin { position: fixed; top: 10px; right: 10px; z-index: 3000; background: #34495e; color: white; padding: 12px; border-radius: 5px; text-decoration: none; font-weight: bold; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
            #sidebar { position: fixed; left: -300px; height: 100%; width: 260px; }
            #sidebar.activo { left: 0; }
        }

        .nicho-item { padding: 10px; border-bottom: 1px solid #34495e; cursor: pointer; }
        .nicho-item:hover { background: #1abc9c; }
        .seleccionado { background: #27ae60 !important; font-weight: bold; border-left: 5px solid white; }
        .ya-ubicado { border-right: 8px solid #3498db; background: #243342; }
        input { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 4px; border: none; box-sizing: border-box; }
        .instrucciones { font-size: 0.8em; color: #bdc3c7; margin-bottom: 10px; }
        .badge { font-size: 0.7em; background: #3498db; padding: 2px 5px; border-radius: 3px; float: right; }
    </style>
</head>
<body>
    <button id="btn-menu" onclick="toggleMenu()">‚ò∞ LISTA</button>
    <a href="/admin" id="btn-admin">‚öôÔ∏è ADMIN</a>
    
    <div id="sidebar" id="sidebar">
        <h4>NICHOS SANARATE</h4>
        <div class="instrucciones">üü¶ Azul = Ya ubicado<br>üü© Verde = Seleccionado</div>
        <input type="text" id="bus" placeholder="üîç Buscar c√≥digo..." onkeyup="filtrar()">
        <div id="lista"></div>
    </div>
    
    <div id="map"></div>

    <script>
        var map = L.map('map').setView([14.78225, -90.20425], 19);
        L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', { maxZoom: 22, subdomains:['mt0','mt1','mt2','mt3'] }).addTo(map);

        var nichos = {{ todos_json|safe }};
        var idActivo = null;

        function toggleMenu() { document.getElementById("sidebar").classList.toggle("activo"); }

        function dibujar() {
            const lista = document.getElementById('lista');
            lista.innerHTML = '';
            let filtro = document.getElementById('bus').value.toUpperCase();
            
            nichos.filter(n => n.codigo.includes(filtro)).forEach(n => {
                let div = document.createElement('div');
                let estaUbicado = n.lat != 0 && n.lat != null;
                div.className = 'nicho-item' + (idActivo == n.id ? ' seleccionado' : '') + (estaUbicado ? ' ya-ubicado' : '');
                div.innerHTML = "<b>" + n.codigo + "</b>" + (estaUbicado ? '<span class="badge">LISTO</span>' : '') + "<br><small>" + n.nombre_difunto + "</small>";
                
                div.onclick = function() { 
                    idActivo = n.id; 
                    dibujar(); 
                    if(window.innerWidth < 768) toggleMenu(); 
                };
                lista.appendChild(div);

                if(estaUbicado) {
                    L.circleMarker([n.lat, n.lng], {radius: 6, color: '#3498db', fillColor: '#3498db', fillOpacity: 0.8}).addTo(map).bindPopup("C√≥digo: " + n.codigo);
                }
            });
        }

        map.on('click', function(e) {
            if(!idActivo) return alert("‚ö†Ô∏è Selecciona un c√≥digo primero.");
            fetch('/actualizar-posicion/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ id: idActivo, lat: e.latlng.lat, lng: e.latlng.lng })
            })
            .then(res => res.json())
            .then(data => { if(data.status === 'ok') location.reload(); });
        });

        function filtrar() { 
            dibujar(); 
            let filtro = document.getElementById("bus").value.toUpperCase(); 
            let n = nichos.find(x => x.codigo === filtro); 
            if(n && n.lat != 0) { 
                map.flyTo([n.lat, n.lng], 22); 
                L.popup().setLatLng([n.lat, n.lng]).setContent("üìç AQU√ç EST√Å: " + n.codigo).openOn(map); 
            } 
        }
        dibujar();
    </script>
</body>
</html>
